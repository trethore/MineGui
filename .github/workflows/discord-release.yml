name: Notify Discord on New Package Version

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Find latest Maven package version
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: trethore
          PKG_TYPE: maven
          WANT_ARTIFACT: minegui
        run: |
          set -e
          
          echo "Fetching package lists for owner: ${OWNER}"
          USER_LIST=$(gh api -H "Accept: application/vnd.github+json" \
            "/users/${OWNER}/packages?package_type=${PKG_TYPE}" 2>/dev/null || echo '[]')
          ORG_LIST=$(gh api -H "Accept: application/vnd.github+json" \
            "/orgs/${OWNER}/packages?package_type=${PKG_TYPE}" 2>/dev/null || echo '[]')

          pick_name() {
            jq -r --arg a "$WANT_ARTIFACT" '
              [.[] | .name] |
              map(select(. == $a or (endswith("." + $a)))) |
              (.[0] // empty)
            '
          }

          PKG_NAME=$(printf '%s' "$USER_LIST" | pick_name)
          SCOPE="user"
          if [ -z "$PKG_NAME" ]; then
            PKG_NAME=$(printf '%s' "$ORG_LIST" | pick_name)
            [ -n "$PKG_NAME" ] && SCOPE="org"
          fi

          if [ -z "$PKG_NAME" ]; then
            echo "Error: Unable to locate Maven package for ${OWNER}"
            echo "Available user packages: $(echo "$USER_LIST" | jq -r '.[].name' 2>/dev/null | tr '\n' ', ' || echo 'none')"
            echo "Available org packages: $(echo "$ORG_LIST" | jq -r '.[].name' 2>/dev/null | tr '\n' ', ' || echo 'none')"
            exit 1
          fi

          echo "Found package: ${PKG_NAME} (scope: ${SCOPE})"

          if [ "$SCOPE" = "user" ]; then
            VERS_JSON=$(gh api -H "Accept: application/vnd.github+json" \
              "/users/${OWNER}/packages/${PKG_TYPE}/${PKG_NAME}/versions?per_page=1")
          else
            VERS_JSON=$(gh api -H "Accept: application/vnd.github+json" \
              "/orgs/${OWNER}/packages/${PKG_TYPE}/${PKG_NAME}/versions?per_page=1")
          fi

          VERSION=$(printf '%s' "$VERS_JSON" | jq -r '.[0].name // empty')
          URL=$(printf '%s' "$VERS_JSON" | jq -r '.[0].html_url // empty')

          if [ -z "$VERSION" ]; then
            echo "Error: No version found for ${OWNER}/${PKG_NAME}"
            echo "API response: $VERS_JSON"
            exit 1
          fi

          echo "Latest version: ${VERSION}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Restore dedupe cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .gh-notify-dedupe
          key: notify-${{ steps.latest.outputs.version }}

      - name: Build Discord payload
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          NAME: ${{ github.event.repository.name }}
          VERSION: ${{ steps.latest.outputs.version }}
          URL: ${{ steps.latest.outputs.url }}
        run: |
          mkdir -p .gh-notify-dedupe
          
          cat > payload.json <<'EOF'
          {
            "content": "**${NAME}** has a new version: **${VERSION}**",
            "embeds": [{
              "title": "Dependency Snippets",
              "url": "${URL}",
              "fields": [
                {
                  "name": "Maven",
                  "value": "```xml\n<dependency>\n  <groupId>tytoo.minegui</groupId>\n  <artifactId>minegui</artifactId>\n  <version>${VERSION}</version>\n</dependency>\n```"
                },
                {
                  "name": "Gradle",
                  "value": "```groovy\nimplementation \"tytoo.minegui:minegui:${VERSION}\"\n```"
                }
              ]
            }]
          }
          EOF
          
          sed -i "s|\${NAME}|$NAME|g; s|\${VERSION}|$VERSION|g; s|\${URL}|${URL:-https://github.com/${GITHUB_REPOSITORY}/packages}|g" payload.json
          echo "$VERSION" > .gh-notify-dedupe/last-version.txt
          
          echo "Discord payload created for version ${VERSION}"

      - name: Send to Discord
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Error: DISCORD_WEBHOOK_URL secret not set"
            exit 1
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" -X POST -d @payload.json "$DISCORD_WEBHOOK_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully sent Discord notification (HTTP ${HTTP_CODE})"
          else
            echo "Error: Discord webhook failed with HTTP ${HTTP_CODE}"
            echo "Response: $(echo "$RESPONSE" | head -n-1)"
            exit 1
          fi