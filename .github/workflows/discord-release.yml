name: Notify Discord on New Package Version (poll)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Find latest Maven package version (REST, user/org + full/short)
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: trethore
          PKG_TYPE: maven
          PKG_FULL: tytoo.minegui%2Fminegui
          PKG_SHORT: minegui
        run: |
          set -e

          USER_LIST=$(gh api -H "Accept: application/vnd.github+json" \
            "/users/${OWNER}/packages?package_type=${PKG_TYPE}" 2>/dev/null || true)

          ORG_LIST=$(gh api -H "Accept: application/vnd.github+json" \
            "/orgs/${OWNER}/packages?package_type=${PKG_TYPE}" 2>/dev/null || true)

          find_pkg_scope() {
            local NAME="$1"
            local SCOPE=""
            echo "$USER_LIST" | jq -e --arg n "$NAME" '.[] | select(.name==$n)' >/dev/null 2>&1 && SCOPE=user
            if [ -z "$SCOPE" ]; then
              echo "$ORG_LIST" | jq -e --arg n "$NAME" '.[] | select(.name==$n)' >/dev/null 2>&1 && SCOPE=org
            fi
            echo "$SCOPE"
          }

          SCOPE=$(find_pkg_scope "$PKG_FULL")
          PKG_NAME="$PKG_FULL"
          if [ -z "$SCOPE" ]; then
            SCOPE=$(find_pkg_scope "$PKG_SHORT")
            PKG_NAME="$PKG_SHORT"
          fi

          if [ -z "$SCOPE" ]; then
            echo "Impossible de localiser le package Maven ($PKG_FULL ou $PKG_SHORT) sous $OWNER (user ou org)."
            echo "USER_LIST: $(echo "$USER_LIST" | jq -r '.[].name' 2>/dev/null || true)"
            echo "ORG_LIST:  $(echo "$ORG_LIST"  | jq -r '.[].name' 2>/dev/null || true)"
            exit 1
          fi

          if [ "$SCOPE" = "user" ]; then
            VERS_JSON=$(gh api -H "Accept: application/vnd.github+json" \
              "/users/${OWNER}/packages/${PKG_TYPE}/${PKG_NAME}/versions?per_page=1")
          else
            VERS_JSON=$(gh api -H "Accept: application/vnd.github+json" \
              "/orgs/${OWNER}/packages/${PKG_TYPE}/${PKG_NAME}/versions?per_page=1")
          fi

          VERSION=$(printf '%s' "$VERS_JSON" | jq -r '.[0].name // empty')
          URL=$(printf '%s' "$VERS_JSON" | jq -r '.[0].html_url // empty')

          if [ -z "$VERSION" ]; then
            echo "Aucune version trouvÃ©e pour ${OWNER}/${PKG_NAME}"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Restore dedupe cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .gh-notify-dedupe
          key: notify-${{ steps.latest.outputs.version }}

      - name: Build Discord payload (only if new)
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          NAME: ${{ github.event.repository.name }}
          VERSION: ${{ steps.latest.outputs.version }}
          URL: ${{ steps.latest.outputs.url }}
        run: |
          mkdir -p .gh-notify-dedupe
          cat > payload.json <<'EOF'
          {
            "content": "**${NAME}** has a new version: **${VERSION}**",
            "embeds": [{
              "title": "Dependency Snippets",
              "url": "${URL}",
              "fields": [
                {
                  "name": "Maven",
                  "value": "```xml\n<dependency>\n  <groupId>tytoo.minegui</groupId>\n  <artifactId>minegui</artifactId>\n  <version>${VERSION}</version>\n</dependency>\n```"
                },
                {
                  "name": "Gradle (Fabric)",
                  "value": "```groovy\nmodImplementation \"tytoo.minegui:minegui:${VERSION}\"\n```"
                }
              ]
            }]
          }
          EOF
          sed -i "s|\${NAME}|$NAME|g; s|\${VERSION}|$VERSION|g; s|\${URL}|${URL:-https://github.com/${GITHUB_REPOSITORY}/packages}|g" payload.json
          echo "$VERSION" > .gh-notify-dedupe/last-version.txt

      - name: Send to Discord (only if new)
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -s -H "Content-Type: application/json" -X POST -d @payload.json "$DISCORD_WEBHOOK_URL"
