name: Notify Discord on Release

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare payload
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          NAME="${{ github.event.repository.name }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          cat > payload.json <<'EOF'
          {
            "content": "New version of ${NAME}: **${VERSION}**",
            "embeds": [{
              "title": "Maven Dependency",
              "description": "```xml\n<dependency>\n  <groupId>tytoo.minegui</groupId>\n  <artifactId>minegui</artifactId>\n  <version>${VERSION}</version>\n</dependency>\n```",
              "url": "${RELEASE_URL}"
            }]
          }
          EOF
          sed -i "s|\${NAME}|$NAME|g; s|\${VERSION}|$VERSION|g; s|\${RELEASE_URL}|$RELEASE_URL|g" payload.json

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -s -H "Content-Type: application/json" \
               -X POST -d @payload.json \
               "$DISCORD_WEBHOOK_URL"
