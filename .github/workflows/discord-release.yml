name: Notify Discord on New Package Version (poll)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest Maven package version via gh api
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: trethore
          PKG_TYPE: maven
          PKG_NAME: tytoo.minegui%2Fminegui
        run: |
          JSON=$(gh api "/users/${OWNER}/packages/${PKG_TYPE}/${PKG_NAME}/versions?per_page=1")
          VERSION=$(printf '%s' "$JSON" | jq -r '.[0].name')
          URL=$(printf '%s' "$JSON" | jq -r '.[0].html_url')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Restore dedupe cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .gh-notify-dedupe
          key: notify-${{ steps.latest.outputs.version }}

      - name: Build Discord payload (only if new)
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          NAME: ${{ github.event.repository.name }}
          VERSION: ${{ steps.latest.outputs.version }}
          URL: ${{ steps.latest.outputs.url }}
        run: |
          mkdir -p .gh-notify-dedupe
          cat > payload.json <<'EOF'
          {
            "content": "**${NAME}** has a new version: **${VERSION}**",
            "embeds": [{
              "title": "Dependency Snippets",
              "url": "${URL}",
              "fields": [
                {
                  "name": "Maven",
                  "value": "```xml\n<dependency>\n  <groupId>tytoo.minegui</groupId>\n  <artifactId>minegui</artifactId>\n  <version>${VERSION}</version>\n</dependency>\n```"
                },
                {
                  "name": "Gradle (Fabric)",
                  "value": "```groovy\nmodImplementation \"tytoo.minegui:minegui:${VERSION}\"\n```"
                }
              ]
            }]
          }
          EOF
          sed -i "s|\${NAME}|$NAME|g; s|\${VERSION}|$VERSION|g; s|\${URL}|${URL:-https://github.com/${GITHUB_REPOSITORY}/packages}|g" payload.json
          echo "$VERSION" > .gh-notify-dedupe/last-version.txt

      - name: Send to Discord (only if new)
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -s -H "Content-Type: application/json" \
               -X POST -d @payload.json \
               "$DISCORD_WEBHOOK_URL"
