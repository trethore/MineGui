name: Notify Discord on Package

on:
  registry_package:
    types: [ published ]

jobs:
  notify:
    if: ${{ github.event.registry_package.package_version != null }}
    runs-on: ubuntu-latest

    concurrency:
      group: ${{ github.workflow }}-${{ github.event.registry_package.name }}-${{ github.event.registry_package.package_version.name }}
      cancel-in-progress: true

    steps:
      - name: Restore dedupe cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .gh-notify-dedupe
          key: notify-${{ github.event.registry_package.name }}-${{ github.event.registry_package.package_version.name }}

      - name: Compute payload
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          NAME: ${{ github.event.repository.name }}
          VERSION: ${{ github.event.registry_package.package_version.name }}
          URL: ${{ github.event.registry_package.package.html_url }}
        run: |
          mkdir -p .gh-notify-dedupe
          cat > payload.json <<'EOF'
          {
            "content": "**${NAME}** has a new version: **${VERSION}**",
            "embeds": [{
              "title": "Dependency Snippets",
              "url": "${URL}",
              "fields": [
                {
                  "name": "Maven",
                  "value": "```xml\n<dependency>\n  <groupId>tytoo.minegui</groupId>\n  <artifactId>minegui</artifactId>\n  <version>${VERSION}</version>\n</dependency>\n```"
                },
                {
                  "name": "Gradle",
                  "value": "```groovy\nimplementation \"tytoo.minegui:minegui:${VERSION}\"\n```"
                }
              ]
            }]
          }
          EOF
          sed -i "s|\${NAME}|$NAME|g; s|\${VERSION}|$VERSION|g; s|\${URL}|${URL:-https://github.com/${GITHUB_REPOSITORY}/packages}|g" payload.json
          # crée un marqueur pour que le cache s'enregistre à la fin
          echo "$VERSION" > .gh-notify-dedupe/last-version.txt

      - name: Send to Discord
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -s -H "Content-Type: application/json" \
               -X POST -d @payload.json \
               "$DISCORD_WEBHOOK_URL"
