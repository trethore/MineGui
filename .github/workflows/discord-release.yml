name: Notify Discord on New Package Version (poll)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Query latest Maven package version via GraphQL (with fallback)
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: trethore                       # <- change si besoin (user ou org)
          PKG_FULL: tytoo.minegui/minegui       # groupId/artifactId
          PKG_SHORT: minegui                    # fallback: juste artifactId
        run: |
          set -e

          gql_query() {
            local PKG_NAME="$1"
            gh api graphql -f query='
              query($owner:String!, $pkg:String!) {
                repositoryOwner(login: $owner) {
                  packages(first: 1, names: [$pkg], packageType: MAVEN) {
                    nodes {
                      name
                      versions(first: 1) {
                        nodes {
                          version
                          url
                        }
                      }
                    }
                  }
                }
              }' -F owner="$OWNER" -F pkg="$PKG_NAME"
          }

          # tentative 1: groupId/artifactId
          JSON=$(gql_query "$PKG_FULL") || true
          VERSION=$(jq -r '.data.repositoryOwner.packages.nodes[0].versions.nodes[0].version // empty' <<<"$JSON")
          URL=$(jq -r '.data.repositoryOwner.packages.nodes[0].versions.nodes[0].url // empty' <<<"$JSON")

          # fallback: artifactId seul
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            JSON=$(gql_query "$PKG_SHORT") || true
            VERSION=$(jq -r '.data.repositoryOwner.packages.nodes[0].versions.nodes[0].version // empty' <<<"$JSON")
            URL=$(jq -r '.data.repositoryOwner.packages.nodes[0].versions.nodes[0].url // empty' <<<"$JSON")
          fi

          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Impossible de trouver le package Maven pour $OWNER. VÃ©rifie OWNER et le nom du package."
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Restore dedupe cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .gh-notify-dedupe
          key: notify-${{ steps.latest.outputs.version }}

      - name: Build Discord payload (only if new)
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          NAME: ${{ github.event.repository.name }}
          VERSION: ${{ steps.latest.outputs.version }}
          URL: ${{ steps.latest.outputs.url }}
        run: |
          mkdir -p .gh-notify-dedupe
          cat > payload.json <<'EOF'
          {
            "content": "**${NAME}** has a new version: **${VERSION}**",
            "embeds": [{
              "title": "Dependency Snippets",
              "url": "${URL}",
              "fields": [
                {
                  "name": "Maven",
                  "value": "```xml\n<dependency>\n  <groupId>tytoo.minegui</groupId>\n  <artifactId>minegui</artifactId>\n  <version>${VERSION}</version>\n</dependency>\n```"
                },
                {
                  "name": "Gradle (Fabric)",
                  "value": "```groovy\nmodImplementation \"tytoo.minegui:minegui:${VERSION}\"\n```"
                }
              ]
            }]
          }
          EOF
          sed -i "s|\${NAME}|$NAME|g; s|\${VERSION}|$VERSION|g; s|\${URL}|${URL:-https://github.com/${GITHUB_REPOSITORY}/packages}|g" payload.json
          echo "$VERSION" > .gh-notify-dedupe/last-version.txt

      - name: Send to Discord (only if new)
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -s -H "Content-Type: application/json" \
               -X POST -d @payload.json \
               "$DISCORD_WEBHOOK_URL"
