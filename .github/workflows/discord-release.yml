name: Notify Discord on New Package Version

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Get latest package version
        id: latest
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_NAME: tytoo.minegui.minegui
          PACKAGE_TYPE: maven
        run: |
          owner=${REPO%%/*}
          repo=${REPO#*/}
          encoded_package=$(python3 -c 'import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1], safe=""))' "$PACKAGE_NAME")
          base_url="https://api.github.com"

          fetch_versions() {
            local path=$1
            curl -s -w "\n%{http_code}" \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "${base_url}/${path}"
          }

          endpoint="users/${owner}/packages/${PACKAGE_TYPE}/${encoded_package}/versions?per_page=1"
          response=$(fetch_versions "$endpoint")
          body=$(printf '%s' "$response" | head -n -1)
          status=$(printf '%s' "$response" | tail -n1)

          if [ "$status" -eq 404 ]; then
            endpoint="orgs/${owner}/packages/${PACKAGE_TYPE}/${encoded_package}/versions?per_page=1"
            response=$(fetch_versions "$endpoint")
            body=$(printf '%s' "$response" | head -n -1)
            status=$(printf '%s' "$response" | tail -n1)
          fi

          if [ "$status" -eq 404 ]; then
            endpoint="repos/${owner}/${repo}/packages/${PACKAGE_TYPE}/${encoded_package}/versions?per_page=1"
            response=$(fetch_versions "$endpoint")
            body=$(printf '%s' "$response" | head -n -1)
            status=$(printf '%s' "$response" | tail -n1)
          fi

          if [ "$status" -lt 200 ] || [ "$status" -ge 300 ]; then
            echo "Failed to fetch package versions (HTTP ${status})"
            printf '%s\n' "$body"
            exit 1
          fi

          tag=$(printf '%s' "$body" | jq -r 'if type=="array" and length>0 then .[0].name // empty else empty end')
          if [ -z "$tag" ]; then
            echo "No package version found"
            printf '%s\n' "$body"
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Restore dedupe cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .gh-notify-dedupe
          key: notify-${{ steps.latest.outputs.tag }}

      - name: Generate Discord payload
        if: steps.cache.outputs.cache-hit != 'true'
        id: payload
        env:
          TAG: ${{ steps.latest.outputs.tag }}
          PACKAGE_NAME: tytoo.minegui.minegui
        run: |
          mkdir -p .gh-notify-dedupe
          set -e

          if [ -x "./gradlew" ]; then
            deps=$(./gradlew dependencies --configuration compileClasspath --console=plain -q || ./gradlew dependencies --console=plain -q || true)
          else
            deps=""
          fi
          deps_snippet=$(printf '%s\n' "$deps" | sed -n '1,40p')

          if command -v cloc >/dev/null 2>&1; then
            cloc_json=$(cloc src/client/ --json --quiet || true)
          else
            cloc_json=""
          fi

          if [ -n "$cloc_json" ] && echo "$cloc_json" | jq . >/dev/null 2>&1; then
            files=$(jq -r '.SUM.nFiles // 0' <<< "$cloc_json")
            code=$(jq -r '.SUM.code // 0' <<< "$cloc_json")
            blank=$(jq -r '.SUM.blank // 0' <<< "$cloc_json")
            comment=$(jq -r '.SUM.comment // 0' <<< "$cloc_json")
            top_langs=$(jq -r '
              del(.header,.SUM)
              | to_entries
              | sort_by(-.value.code)
              | .[:5]
              | map("\(.key): files=\(.value.nFiles) code=\(.value.code)")
              | join("\n")
            ' <<< "$cloc_json")
          else
            files=0
            code=0
            blank=0
            comment=0
            top_langs="n/a"
          fi

          group="${PACKAGE_NAME%.*}"
          artifact="${PACKAGE_NAME##*.}"

          maven_snippet=$(printf '<dependency>\n  <groupId>%s</groupId>\n  <artifactId>%s</artifactId>\n  <version>%s</version>\n</dependency>\n' "$group" "$artifact" "$TAG")
          gradle_snippet=$(printf 'implementation "%s:%s:%s"' "$group" "$artifact" "$TAG")

          dep_field=$(printf 'Maven\n```xml\n%s\n```\nGradle\n```gradle\n%s\n```' "$maven_snippet" "$gradle_snippet")
          code_overview=$(printf '```txt\nFichiers: %s\nCode: %s\nBlancs: %s\nCommentaires: %s\n\nTop langages (par LOC):\n%s\n```' "$files" "$code" "$blank" "$comment" "$top_langs")
          deps_field=$(printf '```txt\n%s\n```' "$deps_snippet")

          jq -n \
            --arg title "MineGui - nouvelle version publiee" \
            --arg desc "**Version:** ${TAG}" \
            --arg dep "$dep_field" \
            --arg cov "$code_overview" \
            --arg dsn "$deps_field" \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: 5814783,
                fields: [
                  { "name": "Dependency Snippets", "value": $dep },
                  { "name": "Code overview (src/client)", "value": $cov },
                  { "name": "Gradle dependencies (extrait)", "value": $dsn }
                ],
                timestamp: (now | todate)
              }]
            }' > payload.json
          echo "$TAG" > .gh-notify-dedupe/last-version.txt


      - name: Send Discord notification
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Error: DISCORD_WEBHOOK_URL secret not set"
            exit 1
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" -X POST -d @payload.json "$DISCORD_WEBHOOK_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully sent Discord notification (HTTP ${HTTP_CODE})"
          else
            echo "Error: Discord webhook failed with HTTP ${HTTP_CODE}"
            echo "Response: $(echo "$RESPONSE" | head -n-1)"
            exit 1
          fi

